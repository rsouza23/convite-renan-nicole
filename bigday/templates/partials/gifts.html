{% load static %}
<div class="container text-center" style="padding: 60px 0;">
    <h2 class="section-heading">Lista de Presentes ğŸ</h2>
    <hr class="primary">

    <p class="lead">
        O melhor presente Ã© ter vocÃª com a gente nesse momento tÃ£o especial ğŸ’–<br>
        Mas, se quiser nos presentear, deixamos aqui algumas opÃ§Ãµes com muito carinho.
    </p>

    <div class="row" style="margin-top:40px;">
        <!-- ITEM 1 -->
        <div class="col-lg-3 col-sm-6">
            <div class="charity-box">
                <img src="{% static 'bigday/images/gifts/geladeira.jpg' %}" class="img-responsive img-rounded" alt="Geladeira Frost Free">
                <h3>Geladeira Frost Free</h3>
                <p>Nos ajude a equipar nossa cozinha com uma geladeira nova. â„ï¸</p>
                <button class="btn btn-primary btn-sm presentear" data-title="Geladeira Frost Free" data-price="3500.00">
                    Presentear ğŸ’
                </button>
            </div>
        </div>

        <!-- ITEM 2 -->
        <div class="col-lg-3 col-sm-6">
            <div class="charity-box">
                <img src="{% static 'bigday/images/gifts/microondas.jpg' %}" class="img-responsive img-rounded" alt="Micro-ondas 30L">
                <h3>Micro-ondas 30L</h3>
                <p>Um toque de praticidade no dia a dia do nosso lar. ğŸ²</p>
                <button class="btn btn-primary btn-sm presentear" data-title="Micro-ondas 30L" data-price="750.00">
                    Presentear ğŸ’
                </button>
            </div>
        </div>

        <!-- ITEM 3 -->
        <div class="col-lg-3 col-sm-6">
            <div class="charity-box">
                <img src="{% static 'bigday/images/gifts/panelas.jpg' %}" class="img-responsive img-rounded" alt="Jogo de Panelas">
                <h3>Jogo de Panelas</h3>
                <p>Contribua com nosso novo cantinho para preparar muitas receitas juntos. ğŸ³</p>
                <button class="btn btn-primary btn-sm presentear" data-title="Jogo de Panelas" data-price="480.00">
                    Presentear ğŸ’
                </button>
            </div>
        </div>

        <!-- ITEM 4 -->
        <div class="col-lg-3 col-sm-6">
            <div class="charity-box">
                <img src="{% static 'bigday/images/gifts/liquidificador.jpg' %}" class="img-responsive img-rounded" alt="Liquidificador">
                <h3>Liquidificador</h3>
                <p>Perfeito para nossos cafÃ©s da manhÃ£ e sucos frescos. ğŸ§ƒ</p>
                <button class="btn btn-primary btn-sm presentear" data-title="Liquidificador" data-price="290.00">
                    Presentear ğŸ’
                </button>
            </div>
        </div>
    </div>

    <div style="margin-top: 50px;">
        <a href="/presentes/" class="btn btn-primary btn-xl" style="border-radius:30px; padding:15px 40px; font-weight:600;">
            Ver todos os presentes ğŸ
        </a>
    </div>
</div>

<!-- SCRIPT MERCADO PAGO -->
<script src="https://sdk.mercadopago.com/js/v2"></script>
<script>
  const mp = new MercadoPago("APP_USR-f8xxxxxxxxxxxxxxxx", { locale: "pt-BR" });

  document.querySelectorAll('.presentear').forEach(btn => {
    btn.addEventListener('click', async () => {
      const title = btn.getAttribute('data-title');
      const price = parseFloat(btn.getAttribute('data-price'));

      try {
        const response = await fetch("/create_preference/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken")
          },
          body: JSON.stringify({ title, price })
        });

        if (!response.ok) throw new Error("Erro na requisiÃ§Ã£o");

        const data = await response.json();
        console.log("Retorno da API:", data);

        if (!data.id) {
          alert("Erro: ID de preferÃªncia nÃ£o encontrado!");
          return;
        }

        // Abre o checkout do Mercado Pago
        window.location.href = data.sandbox_init_point || data.init_point;

      } catch (error) {
        console.error("Erro ao criar preferÃªncia:", error);
        alert("Erro ao iniciar o pagamento. Tente novamente mais tarde.");
      }
    });
  });

  // FunÃ§Ã£o pra obter o CSRF token do Django
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
